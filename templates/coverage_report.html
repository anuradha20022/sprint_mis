{% extends 'base.html' %}
{%  block content_heading %}Coverage Report{% endblock %}
{%  block content_subheading %}Coverage Report{% endblock %}
{% block title %} Coverage Report {% endblock %}



{% block body %}
    <style>
    /* Style the form - display items horizontally */
.form-inline {
  display: flex;
  flex-flow: row wrap;
  align-items: center;
}

/* Add some margins for each label */
.form-inline label {
  margin: 5px 10px 5px 0;
}

/* Style the input fields */
.form-inline input,select{
  vertical-align: middle;
  margin: 5px 10px 5px 0;
  padding: 10px;
  background-color: #fff;
  border: 1px solid #ddd;
}

/* Style the submit button */
.form-inline button {
  padding: 10px 20px;
  background-color: dodgerblue;
  border: 1px solid #ddd;
  color: white;
}

.form-inline button:hover {
  background-color: royalblue;
}

/* Add responsiveness - display the form controls vertically instead of horizontally on screens that are less than 800px wide */
@media (max-width: 800px) {
  .form-inline input {
    margin: 10px 0;
  }

  .form-inline {
    flex-direction: column;
    align-items: stretch;
  }
}
#mytitle,#submit {
  font-family: Arial, Helvetica, sans-serif;
}
#customers {
  font-family: Arial, Helvetica, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

#customers td, #customers th {
      font-family: Arial, Helvetica, sans-serif;
  border: 1px solid #ddd;
  padding: 8px;
}

#customers tr:nth-child(even){background-color: #f2f2f2;}

#customers tr:hover {background-color: #ddd}

#customers th {
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: #1268b2;
  color: white;
}
    </style>
    <form action="" method="post">
    {% csrf_token %}
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <select class="form-control" name="branch">
                        <option value="" disabled>-- Select Branch --</option>
                        <option value="All" selected>All</option>
                        {% for list in branch %}
                            <option value="{{ list.branch_name }}">{{ list.branch_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <input type="date" name="date" class="form-control">
            </div>
            <div class="col-md-2">
                <button type="submit" name="Submit" class="btn btn-lg btn-primary btn-gradient btn-shadow">Submit</button>
            </div>
        </div>
    </form>

            <div class="row pb-4">
                <div class="col-md-12">
                    <div class="card card-body">
                    <hr>
                        <div class="table-responsive">
                            <table id="" class="table table-striped table-bordered cus-responsive-datatable" style="white-space: nowrap">

                            <thead>
                              <tr role="row" style="background: #3F51B5; color: #fff;">
                                         <th  class="py-2" style="text-align:center;">Sno</th>
                                         <th  class="py-2" style="text-align:center;">Location</th>
                                          <th  class="py-2" style="text-align:center;">Employee ID</th>
                                          <th  class="py-2" style="text-align:center;">Employee Name</th>
                                          <th  class="py-2" style="text-align:center;">First Call Time</th>
                                         <th  class="py-2" style="text-align:center;">No. of Calls</th>
                                         <th  class="py-2" style="text-align:center;">Address</th>
                              </tr>
                            </thead>
                                <tbody>
                                {% for ref in result %}
                                     {% if ref.TOTAL == 0 %}
                                           <tr>
                                               <td class="py-2">{{ forloop.counter }}</td>
                                               <td class="py-2">{{ ref.branch }}</td>
                                               <td  class="py-2">{{ ref.empid }}</td>
                                               <td  class="py-2">{{ ref.name }}</td>
                                               <td class="py-2">{{ ref.MINTIME|time:'h:i:s'|default:'No Data' }}</td>
                                               <td style="text-align:center;" class="py-2">No Data</td>
                                               <td style="text-align:center;" class="py-2">No Data</td>
                                            </tr>
                                       {% else %}
                                    <tr>
                                        <td class="py-2">{{ forloop.counter }}</td>
                                        <td class="py-2">{{ ref.branch }}</td>
                                        <td class="py-2">{{ ref.empid }}</td>
                                        <td class="py-2">{{ ref.name }}</td>
                                        <td class="py-2">{{ ref.MINTIME|time:'h:i:s' }}</td>
                                        <td class="py-2" style='text-align:center;'>{{ ref.TOTAL }} ({{ ref.QUA }} - Qualified, {{ ref.REG }} - Registered, {{ ref.SPC }} - Special)</td>
                                        <td class="py-2">{{ ref.area }},{{ ref.city }},{{ ref.state }},{{ ref.pincode }}</td>
                                    </tr>
                                    {% endif %}
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

{% endblock %}


        cur.execute("SELECT `Emp_name`,`Emp_ID`,(SELECT COUNT(`unique_id`) FROM `doctor_agent_list` "
                    "WHERE `emp_id` = `logins`.`Emp_ID` AND `category` = 'A') AS aTotalcount, (SELECT COUNT(`unique_id`)"
                    " FROM `doctor_agent_list` WHERE `emp_id` = `logins`.`Emp_ID` AND `category` = 'B') AS bTotalcount,"
                    " (SELECT COUNT(`unique_id`) FROM `doctor_agent_list` WHERE `emp_id` = `logins`.`Emp_ID` AND `category` = 'C') "
                    "AS cTotalcount, (SELECT COALESCE(SUM(av1),0) FROM (SELECT IF(COUNT(`call_report_master`.`unique_id`) = 1, 1, 0) "
                    "AS av1 FROM `call_report_master` INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                   " WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'A'"
                     " AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     " AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     " AND `call_report_master`.`unique_id` != ''"
                     "  GROUP BY `call_report_master`.`unique_id`"
                     "  ORDER BY `call_report_master`.`emp_id` ASC"
                     ") AS av1) AS AV1,"
                     "(SELECT COALESCE(SUM(bv1),0) FROM ("
                     "  SELECT IF(COUNT(`call_report_master`.`unique_id`) = 1, 1, 0) AS bv1"
                     "  FROM `call_report_master`"
                     "  INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     " WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'B'"
                     " AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     " AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     " AND `call_report_master`.`unique_id` != ''"
                     "  GROUP BY `call_report_master`.`unique_id`"
                     "  ORDER BY `call_report_master`.`emp_id` ASC"
                     ") AS av1) AS BV1,"
                     "(SELECT COALESCE(SUM(cv1),0) FROM ("
                     "  SELECT IF(COUNT(`call_report_master`.`unique_id`) = 1, 1, 0) AS cv1"
                     "  FROM `call_report_master`"
                     "  INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     " WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'C'"
                     " AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     " AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     " AND `call_report_master`.`unique_id` != ''"
                     "  GROUP BY `call_report_master`.`unique_id`"
                     "  ORDER BY `call_report_master`.`emp_id` ASC"
                     ") AS av1) AS CV1,"
                     " (SELECT COALESCE(SUM(av2),0) FROM ("
                     "   SELECT IF(COUNT(`call_report_master`.`unique_id`) = 2, 1, 0) AS av2"
                     "   FROM `call_report_master`"
                     "   INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'A'"
                     "  AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `call_report_master`.`unique_id` != ''"
                     "   GROUP BY `call_report_master`.`unique_id`"
                     "   ORDER BY `call_report_master`.`emp_id` ASC"
                     " ) AS av2) AS AV2,"
                     " (SELECT COALESCE(SUM(bv2),0) FROM ("
                     "   SELECT IF(COUNT(`call_report_master`.`unique_id`) = 2, 1, 0) AS bv2"
                     "   FROM `call_report_master`"
                     "   INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'B'"
                     "  AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `call_report_master`.`unique_id` != ''"
                     "   GROUP BY `call_report_master`.`unique_id`"
                     "   ORDER BY `call_report_master`.`emp_id` ASC"
                     " ) AS bv2) AS BV2,"
                     " (SELECT COALESCE(SUM(cv2),0) FROM ("
                     "   SELECT IF(COUNT(`call_report_master`.`unique_id`) = 2, 1, 0) AS cv2"
                     "   FROM `call_report_master`"
                     "   INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'C'"
                     "  AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `call_report_master`.`unique_id` != ''"
                     "   GROUP BY `call_report_master`.`unique_id`"
                     "   ORDER BY `call_report_master`.`emp_id` ASC"
                     " ) AS cv2) AS CV2,"
                     " (SELECT COALESCE(SUM(av3),0) FROM (SELECT if(COUNT(`call_report_master`.`unique_id`)>2,1,0) AS av3 FROM `call_report_master`"
                     "   INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'A'"
                     "  AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `call_report_master`.`unique_id` != ''"
                     "   GROUP BY `call_report_master`.`unique_id`"
                     "   ORDER BY `call_report_master`.`emp_id` ASC"
                     " ) AS av3) AS AV3,"
                     "  (SELECT COALESCE(SUM(bv3),0) FROM (SELECT if(COUNT(`call_report_master`.`unique_id`)>2,1,0) AS bv3 FROM `call_report_master`"
                     "   INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'B'"
                     "  AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `call_report_master`.`unique_id` != ''"
                     "   GROUP BY `call_report_master`.`unique_id`"
                     "   ORDER BY `call_report_master`.`emp_id` ASC"
                     " ) AS bv3) AS BV3,"

                     "  (SELECT COALESCE(SUM(cv3),0) FROM (SELECT if(COUNT(`call_report_master`.`unique_id`)>2,1,0) AS cv3 FROM `call_report_master`"
                     "   INNER JOIN `doctor_agent_list` ON `doctor_agent_list`.`unique_id` = `call_report_master`.`unique_id`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'C'"
                     "  AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `doctor_agent_list`.`date` BETWEEN '{fd}' AND '{td}' "
                     "  AND `call_report_master`.`unique_id` != ''"
                     "   GROUP BY `call_report_master`.`unique_id`"
                     "   ORDER BY `call_report_master`.`emp_id` ASC"
                     " ) AS cv3) AS CV3,"
                     "   (SELECT COALESCE(SUM(eav1), 0)FROM (SELECT IF(COUNT(`unique_id`) = 1, 1, 0) AS eav1 FROM `call_report_master`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'A'"
                     "       AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS eav1 ) AS EAV1,"
                     "       (SELECT COALESCE(SUM(ebv1), 0)FROM (SELECT IF(COUNT(`unique_id`) = 1, 1, 0) AS ebv1 FROM `call_report_master`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'B'"
                     "       AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS ebv1 ) AS EBV1,"
                     "       (SELECT COALESCE(SUM(ecv1), 0)FROM (SELECT IF(COUNT(`unique_id`) = 1, 1, 0) AS ecv1 FROM `call_report_master`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'C'"
                     "       AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS ecv1 ) AS ECV1,"
                     "        (SELECT COALESCE(SUM(eav2), 0)FROM (SELECT IF(COUNT(`unique_id`) = 2, 1, 0) AS eav2 FROM `call_report_master`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'A'"
                     "       AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS eav2 ) AS EAV2,"
                     "   (SELECT COALESCE(SUM(ebv2), 0)FROM (SELECT IF(COUNT(`unique_id`) = 2, 1, 0) AS ebv2 FROM `call_report_master`"
                     "  WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'B'"
                     "       AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS ebv2 ) AS EBV2,"
                     "(SELECT COALESCE(SUM(ecv2), 0)FROM (SELECT IF(COUNT(`unique_id`) = 2, 1, 0) AS ecv2 FROM "
                    "`call_report_master` "

               "WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'C'"
               "     AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS ecv2 ) AS ECV2,"
               "     (SELECT COALESCE(SUM(eav3),0) FROM (SELECT if(COUNT(`unique_id`)>2,1,0) AS eav3 FROM call_report_master"
               "WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'A'"
               "     AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS eav3 ) AS EAV3,"
               "     (SELECT COALESCE(SUM(ebv3),0) FROM (SELECT if(COUNT(`unique_id`)>2,1,0) AS ebv3 FROM call_report_master"
               "WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'B'"
               "     AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS ebv3 ) AS EBV3,"
               "     (SELECT COALESCE(SUM(ecv3),0) FROM (SELECT if(COUNT(`unique_id`)>2,1,0) AS ecv3 FROM call_report_master"
               "WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID` AND `call_report_master`.`category` = 'C'"
               "     AND `call_report_master`.`date` BETWEEN '{fd}' AND '{td}'  AND `unique_id` != '' GROUP BY `call_report_master`.`unique_id` ORDER BY  `call_report_master`.`emp_id` ASC) AS ecv3 ) AS ECV3,"
               "         (SELECT COALESCE(SUM(aothers1), 0) FROM (SELECT IF(doctor_agent_list.emp_id != call_report_master.emp_id, 1, 0) AS aothers1 FROM  `call_report_master`"
               "   INNER JOIN doctor_agent_list ON  `call_report_master`.unique_id = doctor_agent_list.unique_id WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID`"
               "    AND  `call_report_master`.category = 'A'"
               "    AND  `call_report_master`.date BETWEEN '{fd}' AND '{td}' "
               "    AND  `call_report_master`.unique_id != ''"
               "   GROUP BY  `call_report_master`.unique_id"
               "   ORDER BY  `call_report_master`.emp_id ASC"
               " ) AS aothers1) AS aothers1,"
             "   (SELECT COALESCE(SUM(bothers1), 0) FROM (SELECT IF(doctor_agent_list.emp_id != call_report_master.emp_id, 1, 0) AS bothers1 FROM  `call_report_master` INNER JOIN doctor_agent_list ON  `call_report_master`.unique_id = doctor_agent_list.unique_id WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID`"
             "        AND  `call_report_master`.category = 'B'"
             "        AND  `call_report_master`.date BETWEEN '{fd}' AND '{td}' "
             "        AND  `call_report_master`.unique_id != ''"
             "       GROUP BY  `call_report_master`.unique_id"
             "       ORDER BY  `call_report_master`.emp_id ASC"
             "     ) AS bothers1"
             "   ) AS bothers1,"
             "  (SELECT COALESCE(SUM(cothers1), 0) FROM (SELECT IF(doctor_agent_list.emp_id != call_report_master.emp_id, 1, 0) AS cothers1 FROM  `call_report_master`"
             "   INNER JOIN doctor_agent_list ON  `call_report_master`.unique_id = doctor_agent_list.unique_id WHERE `call_report_master`.`emp_id` = `logins`.`Emp_ID`"
             "        AND  `call_report_master`.category = 'C'"
             "        AND  `call_report_master`.date BETWEEN '{fd}' AND '{td}' "
             "        AND  `call_report_master`.unique_id != ''"
             "       GROUP BY  `call_report_master`.unique_id"
             "       ORDER BY  `call_report_master`.emp_id ASC"
             "     ) AS cothers1"
             "   ) AS cothers1"
             "   FROM `logins`"
             "WHERE `Page` = 'Marketing'"
             "  AND `Job_Status` = 'Active'"
             "  AND `branch` = 'Kukatpally';")
