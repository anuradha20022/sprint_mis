{% extends 'base.html'%}
{%  block content_heading %} Bills {% endblock %}
{%  block content_subheading %} Bills List{% endblock %}
{% block title %} Bills List{% endblock %}

{% block script %}
<script>

    let delete_value;
    $(".reject-payment").on('click', function () {
            delete_value = $(this).data('payment');
            swal({
                  title: "Are you sure?",
                  text: "Do you want to Reject pending payment.",
                  type: "warning",
                  showCancelButton: true,
                  confirmButtonColor: "#DD6B55",
                  confirmButtonText: "Yes, Reject it!",
                  cancelButtonText: "No, cancel!",
                  closeOnConfirm: false,
                  closeOnCancel: false
                },
                function(isConfirm){
                  if (isConfirm !== false) {

                    $.ajax({
                        url: '{% url "bill_list" %}',
                        data: {delete_sno: delete_value},
                        success: function (response) {
                            if (response.success) {
                                swal("Deleted!", `Deleted Successfully!`, "success");
                                location.reload();
                            }else swal("Failed!", `Failed to Delete!`, "warning");
                        },
                        error: function () {
                            alert('Oops something went wrong!')
                        }
                    });
                  } else {
                    {#swal("Cancelled", "Operation cancelled successfully :)", "error");#}
                  }
                });
    });

$('#cus-responsive-datatable').DataTable({
            serverSide: true,
            processing: true,
            paging: true,
            lengthChange: true,
            "pageLength": 10,
            {#"lengthMenu": [[13, 25, 50, -1], [13, 25, 50, "All"]],#}
            searching: true,
            destroy: true,
            info: true, // bottom left info
            responsive: false, // responnsive table
            {#"deferRender": true,#}
            ajax: {
                url: "{% url 'admission' %}",
                type: "POST",
            },

            columns:[
                {data: "sno"},
                {data: "edit",
                    render: function(data, type, row) {
                    return '<a class="icon-pencil mr-2 text-info edit-admission" data-toggle="modal" data-target="#admissionModal" onclick="editAdmission('+row.sno+')" ></a>'
                        {#+#}
                        {#'<a href="/admission_list/?delete='+row.sno+'" class="btn btn-sm btn-danger reject-payment"><i class="icon-trash" aria-hidden="true"></i></a>'#}
                    }

                },

                {#{data: "",#}
                {# render: function () {#}
                    {#let data = data();#}
                    {#console.log(data);#}
                {#     var row = $(this).closest('tr');#}
                {#        var id = table.row(row).data().sno;#}
                {#    return  `<a href="#"  data-adm="${id}" class="icon-pencil mr-2 text-info edit-admission" data-toggle="modal" data-target="#admissionModal" ></a>`#}
                {##}
                {# }},#}
                {data: "invoice_no"},
                {data: "branch"},
                {data: "patient_name"},
                {data: "service_name"},
                {data: "department_name"},

                {#{data: "marketing_executive"},#}
                {#{data: "referral_type"},#}
                {#{data: "referralpercentage"},#}
                {#{data: "referralpercentagename"},#}
                {data: "grossamount"},
                {data: "discount"},
                {data: "netamount"},
                {#{data: "referralamount"},#}
                {#{data: "ucidcreatedon"},#}
                {#{data: "paymentmode"},#}

            ],
        });


    {% comment %}$(".edit-admission").on('click', function () {
        let edit_value = $(this).data('adm');
        console.log(edit_value);
        $.ajax({
            url: '{% url 'admission_list' %}',
            data: {sno: edit_value},
            success: function (response) {
                $('#invoice_no').html(response.invoice_no);
                $('#ucid_search').html(response.sno);
                $('#sno').html(response.sno);
                $('#sno_input').val(response.sno);
                $('#grossamount').html(response.grossamount);
                $('#discount').html(response.discount);
                $('#netamount').html(response.netamount);
                $('#serviceamount').html(response.serviceamount);
                $('#marketingExecutive ').val(response.marketing_executive );
                $('#referralDoctor ').val(response.patient_name );
                $('#referralType ').val(response.referral_type );
                $('#changeValue ').val(response.referralpercentage );
                $('#calculationType ').val(response.referralpercentagename );
                $('#referralAmount ').val(response.referralamount );

            },
            error: function () {
                alert('Oops something went wrong!')
            }
        })
    });{% endcomment %}

    function editAdmission(edit_value){
        {#let edit_value = $(this).data('adm');#}
        {#console.log(edit_value);#}
        $('#update_form').trigger('reset');
        $.ajax({
            url: '{% url 'bill_list' %}',
            data: {sno: edit_value},
            success: function (response) {
                $('#sno').html(response.sno);
                $('#modal_sno').val(response.sno);
                $('#invoice_no').html(response.invoice_no);
                $('#grossamount').html(response.grossamount);
                $('#discount').html(response.discount);
                $('#netamount').html(response.netamount);
                $('#serviceamount').html(response.serviceamount);


                $('#marketingExecutive').val(response.agent_name );
                $('#bankid_search').val(response.unique_id);
                $('#referralDoctor').val(response.patient_name );

            },
            error: function () {
                alert('Oops something went wrong!')
            }
        })
    }

    $("#admission_list_filter_form").submit(function (e) {
        e.preventDefault();
        let branch = $("#branch_input").val();
        $("#cus-responsive-datatable").attr("id", "admission_list_filter_table");
        $('#admission_list_filter_table').DataTable({
                    serverSide: true,
                    processing: true,
                    paging: true,
                    lengthChange: true,
                    destroy:true,
                    "pageLength": 10,
                    {#"lengthMenu": [[13, 25, 50, -1], [13, 25, 50, "All"]],#}
                    searching: true,
                    info: true, // bottom left info
                    responsive: false, // responnsive table
                    {#"deferRender": true,#}
                    ajax: {
                        url: `{% url 'admission_list_filter' %}?branch=${branch}`,
                        {#data: formData,#}
                    },

                    columns:[
                        {data: "sno" },
                        {data: "edit",
                            render: function(data, type, row) {
                            return '<a class="icon-pencil mr-2 text-info edit-admission" data-toggle="modal" data-target="#admissionModal" onclick="editAdmission('+row.sno+')" ></a>'
                                {#+#}
                                {#'<a href="/admission_list/?delete='+row.sno+'" class="btn btn-sm btn-danger"><i class="icon-trash" aria-hidden="true"></i></a>'#}
                            }
                        },
                        {data: "invoice_no"},
                        {data: "branch"},
                        {data: "patient_name"},
                        {data: "service_name"},
                        {data: "department_name"},
                        {data: "grossamount"},
                        {data: "discount"},
                        {data: "netamount"},
                    ],
                });
    });


    $(document).ready(
        $('#calculationType').bind('change',
            function () {
                let calculationType = $('option:selected', this).text();
                if (calculationType === "Value"){
                    $('#labelPercentageValue').text('Enter Value');
                    $('#changeValue').text('type', 'text');
                    $('#changeValue').val(" ");
                    $('#referralAmount').val("");
                }else if(calculationType === "Percentage"){
                    $('#labelPercentageValue').text('Enter Percentage');
                       $('#changeValue').text('type', 'text');
                    $('#changeValue').val("");
                    $('#referralAmount').val("");

                }
            }
        )
    );


    function calculation() {
        let calculationType = document.getElementById("calculationType").value;

        if (calculationType === "Percentage") {
            $('#labelPercentageValue').text('Enter Percentage');
            let per_val = $('#changeValue').text('type', 'number');
            let ser_amt = $('#serviceamount').html();
            let per_input_val = parseFloat(per_val.val()) * parseFloat(ser_amt) / 100;
            let ref_amt = $('#referralAmount');
            ref_amt.val(per_input_val);
            {#console.log(per_input_val);#}
        }
    }

    $('.value input.qty').on('input', updateProductAmount);

    function updateProductAmount() {
        var referralAmount = this.value;
        $('.value input.qty').each(function() {
            $('.value .qty').val(referralAmount);
            // Requires more work.
        });
    }

    $('#referralPaymentMode').change(function () {

        if ($(this).val() === "NetBanking" ) {
            $("#bank_details_div").show();
            $("#upinumber_div").hide();

        } else if ($(this).val() === "UPI" ) {
            $("#upinumber_div").show();
            $("#bank_details_div").hide();
        }else {
            $("#upinumber_div").hide();
            $("#bank_details_div").hide();

        }

           });
$(document).ready(function(){
    $('[id^=accnumber]').keypress(validateNumber);
});

function validateNumber(event) {
    let key = window.event ? event.keyCode : event.which;
    if (event.keyCode === 8 || event.keyCode === 46) {
        return true;
    } else if ( key < 48 || key > 57 ) {
        return false;
    } else {
    	return true;
    }
}
</script>
{% endblock %}

{% block body %}
<style>
.ui-autocomplete{
        z-index: 999999;
    }
.table thead tr th, .table thead tr td{
    padding: 5px!important;
}
.table th, .table td {
    padding: 6px!important;
}

.table td:first-child {
    text-align: left;
}​


</style>
    <form id="admission_list_filter_form" method="post" autocomplete="off">
    {% csrf_token %}
        <div class="row">
            <div class="col-md-3">
                <div class="form-group">
                    <select class="form-control " name="branch" id="branch_input">
                        <option value="" disabled >-- Select Branch --</option>
                        <option value="All" selected>All</option>
                        {% for list in branch %}
                            <option value="{{ list.branch_name }}">{{ list.branch_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="col-md-3">
                <button type="submit" name="Submit" class="btn btn-lg btn-primary btn-gradient btn-shadow">Submit</button>
            </div>

        </div>
    </form>



 <div class="row pb-4">
     <div class="col-md-12">
         <div class="card card-body">
          <div class="table-responsive">
           <table id="cus-responsive-datatable" class="table table-striped table-bordered " style="white-space: nowrap">
            <thead>
           <tr role="row" style="background: #3F51B5; color: #fff; width: 1652px;">
                <th class="py-2 " data-orderable="false" width="60">Sno</th>
                <th class="py-2" data-orderable="false" >Edit</th>
                <th class="py-2" data-orderable="false">IP NO</th>
                <th class="py-2" data-orderable="false">Branch</th>
                <th class="py-2" data-orderable="false">Patient Name</th>

                <th class="py-2" data-orderable="false">Service Name</th>
                <th class="py-2" data-orderable="false">Department Name</th>
                <th class="py-2" data-orderable="false">Gross Bill Amount</th>
                <th class="py-2" data-orderable="false">Discount Amount</th>
                <th class="py-2" data-orderable="false">Net Bill Amount</th>
            </tr>
            </thead>
               <tbody>
               {%  for adm in admission %}
                 <tr>
{#                     <td class="py-2 text-right">{{ forloop.counter }}</td>#}
                     <td class="py-2"> <a href="#"  data-adm="{{ adm.sno }}" class="icon-pencil mr-2 text-info edit-admission" data-toggle="modal" onclick="editAdmission()" data-target="#admissionModal" ></a>
{#                      <a href="#"  data-adm="{{ adm.sno }}" class="icon-trash text-danger deleteRow" data-target="#deleteRow"></a></td>#}

{#                        <a href="#" data-payment="{{ adm.sno }}" class="icon-trash reject-payment" name="delete">Delete</a>#}
                     </td>
                     <td class="py-2 text-right">{{ adm.sno }}</td>
                     <td class="py-2">{{ adm.invoice_no }}</td>
                     <td class="py-2">{{ adm.branch }}</td>
                     <td class="py-2">{{ adm.patient_name }}</td>
                     <td class="py-2">{{ adm.service_name }}</td>
                     <td class="py-2">{{ adm.department_name }}</td>
                     <td class="py-2">{{ adm.grossamount }}</td>
                     <td class="py-2">{{ adm.discount }}</td>
                     <td class="py-2">{{ adm.netamount }}</td>
                 </tr>
               {% endfor %}
              </tbody>
        </table>
    </div>
         </div>
     </div>

    <div class="modal fade" id="admissionModal">
        <div class="modal-dialog modal-lg" style="max-width: 1200px">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="largeModalLabel">Update Details</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body">

  <form action="" method="post" id="update_form" autocomplete="off">
                 {% csrf_token %}
      <input type="number" class="form-control form-control-sm" name="modal_sno" id="modal_sno" hidden>

                    <div class="table-responsive">
                        <table class="table table-striped ">
                            <thead>
                            <tr>
                                <th>S no</th>
                                <th>Bill number</th>
                                <th>Gross Bill Amount</th>
                                <th>Discount Amount</th>
                                <th>Net Bill Amount</th>
                                <th>Pharmacy & Cons</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td class="py-1" id="sno"></td>
                                <td class="py-1" id="invoice_no"></td>
                                <td class="py-1" id="grossamount"></td>
                                <td class="py-1" id="discount"></td>
                                <td class="py-1" id="netamount"></td>
                                <td class="py-1" id="serviceamount"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="row">
                              <div class="col-md-4">
                                <div class="form-group">
                                    <label for="UCID">UCID</label><span class="text-danger">*</span>
                                    <input type="text" class="form-control form-control-sm" name="unique_id" id="bankid_search" placeholder="Search by UCID / Name / Mobile" autocomplete="off" required>
                                </div>
                            </div>
                             <div class="col-md-4">
                                <div class="form-group">
                                    <label for="referralDoctor">Patient Name</label><span class="text-danger">*</span>
                                    <input type="text" class="form-control form-control-sm" name="patient_name" id="referralDoctor" placeholder="Referral Doctor" readonly required>
                                </div>
                            </div>
                             <div class="col-md-4">
                                <div class="form-group">
                                    <label for="marketingExecutive">Referral Doctor/ Agent Name</label><span class="text-danger">*</span>
                                    <input type="text" class="form-control form-control-sm"  name="agent_name" id="marketingExecutive" placeholder="Agent Name" readonly required>
                                </div>
                            </div>
                       </div>
                               <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="calculationType">Calculation Type</label><span class="text-danger">*</span>
                                        <select class="form-control form-control-sm " name="referralpercentagename" id="calculationType" required>
                                            <option value="" disabled>-select Percentage Type-</option>
                                            <option value="Value" >Value</option>
                                            <option value="Percentage" >Percentage</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group value">
                                        <label for="changeValue" id="labelPercentageValue">Enter Value</label><span class="text-danger">*</span>
                                        <input type="number" class="form-control form-control-sm qty" name="referralpercentage" id="changeValue" onkeyup="calculation()" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group value">
                                        <label for="referralAmount">Referral Amount</label><span class="text-danger">*</span>
                                        <input type="number" class="form-control form-control-sm qty" name="referralamount" id="referralAmount" readonly required>
                                    </div>
                                </div>
                    </div>
                             <div class="row">

                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="referralPaymentMode">Refferal Payment Mode</label><span class="text-danger">*</span>
                                        <select class="form-control form-control-sm" name="paymentmode" id="referralPaymentMode" required>
                                            <option disabled>-Select Payment Mode-</option>
                                            <option value="Cash" selected>Cash</option>
                                            <option value="UPI" >UPI</option>
                                            <option value="NetBanking">NetBanking</option>
{#                                            <option value="Cheque" >Cheque</option>#}
                                        </select>
                                    </div>
                                </div>
                                 <div class="col-md-4">
                                  <div class="form-group">
                                      <label for="referral_type">Referral Type</label><span class="text-danger">*</span>
                                      <select class="form-control form-control-sm" name="referral_type" id="referral_type" required>
                                         <option value="" disabled>-Select Payment Mode-</option>
                                        <option value="Walkin">Walkin</option>
                                        <option value="Old patient">Old patient</option>
                                        <option value="Cross Referral">Cross Referral</option>
                                        <option value="Self">Self</option>
                                        <option value="Marketing executive">Marketing executive</option>
                                        <option value="Visiting Consultant">Visiting Consultant</option>
                                        <option value="Referral" selected="selected">Referral</option>
                                    </select>
                                </div>

                              </div>

                             </div>
                            <div id="bank_details_div" style="display: none;">
                                <h4 class="card-title mb-0">Bank Details</h4>
                                <hr class="mt-0">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="referralPaymentMode">Bank Acc</label>
                                            <input type="number" class="form-control form-control-sm" name="accnumber" id="accnumber" >
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="referralPaymentMode">Ifsc Code</label>
                                            <input type="text" style="text-transform: uppercase;" class="form-control form-control-sm" name="ifsccode" id="ifsccode" pattern="^[A-Za-z]{4}[a-zA-Z0-9]{7}$" maxlength="11">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <label for="referralPaymentMode">Pan Card</label>
                                            <input type="text" style="text-transform: uppercase;" class="form-control form-control-sm" name="pancard" id="pancard" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" maxlength="10">

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3"  id="upinumber_div" style="display: none;">
                               <div class="form-group">
                                   <label for="referralPaymentMode">UPI number</label>
                                   <input type="text" style="text-transform: uppercase;" class="form-control form-control-sm" name="upinumber" id="upinumber">

                               </div>
                           </div>
                            </div>

                         <div class="submit-section">
                             <input class="btn btn-success" type="submit">
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
    </div>

{% endblock %}